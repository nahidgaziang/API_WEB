<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learner Dashboard - LMS</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">LMS</div>
        <ul class="navbar-menu">
            <li><a href="/learner/dashboard.html" class="navbar-link">Dashboard</a></li>
            <li><a href="/learner/courses.html" class="navbar-link">Browse Courses</a></li>
            <li><a href="/learner/my-courses.html" class="navbar-link">My Courses</a></li>
            <li><a href="/learner/certificates.html" class="navbar-link">Certificates</a></li>
            <li><span class="user-name" style="font-weight: 500;"></span></li>
            <li><a href="#" onclick="logout()" class="navbar-link">Logout</a></li>
        </ul>
    </nav>
    <div class="container" style="margin-top: 2rem;">
        <h1 class="mb-3">Welcome, <span class="user-name"></span>!</h1>
        <div class="grid grid-3 mb-4">
            <div class="card" style="background: var(--gradient-card); color: white;">
                <h3 style="color: white;">üí≥ Account Balance</h3>
                <p class="course-price" style="color: white; margin: 1rem 0;" id="balance">0.00</p>
                <small style="color: rgba(255,255,255,0.9);" id="account-number">Account: ---</small>
            </div>
            <div class="card" style="background: var(--gradient-teal); color: white;">
                <h3 style="color: white;">üìö My Enrollments</h3>
                <p class="course-price" style="color: white; margin: 1rem 0;" id="enrollment-count">0</p>
                <small style="color: rgba(255,255,255,0.9);">Courses enrolled</small>
            </div>
            <div class="card" style="background: var(--gradient-success); color: white;">
                <h3 style="color: white;">üèÜ Certificates</h3>
                <p class="course-price" style="color: white; margin: 1rem 0;" id="certificate-count">0</p>
                <small style="color: rgba(255,255,255,0.9);">Earned certificates</small>
            </div>
        </div>
        <div class="card mb-4">
            <h3 class="mb-3">‚ö° Quick Actions</h3>
            <div class="flex gap-2" style="flex-wrap: wrap;">
                <a href="/learner/courses.html" class="btn btn-primary">Browse All Courses</a>
                <a href="/learner/my-courses.html" class="btn btn-teal">View My Courses</a>
                <a href="/learner/certificates.html" class="btn btn-success">üèÜ My Certificates</a>
                <button onclick="document.getElementById('topup-modal').style.display='flex'" class="btn btn-amber">üí∞
                    Top Up Balance</button>
            </div>
        </div>
        <div id="topup-modal"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; justify-content:center; align-items:center;">
            <div class="card" style="width:100%; max-width:420px; margin:1rem; position:relative;">
                <button onclick="document.getElementById('topup-modal').style.display='none'"
                    style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--gray); line-height:1;">‚úï</button>
                <h3 class="mb-3">üí∞ Top Up Balance</h3>
                <div id="topup-alert"></div>
                <form id="topup-form">
                    <div class="form-group">
                        <label class="form-label">Amount (Tk) *</label>
                        <input type="number" class="form-input" id="topup-amount" min="1" max="100000" step="1"
                            placeholder="e.g. 500" required>
                        <small style="color:var(--gray);">Min: 1 Tk ¬∑ Max: 100,000 Tk</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bank Secret *</label>
                        <input type="password" class="form-input" id="topup-secret"
                            placeholder="Your bank account secret" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="topup-btn"
                        style="margin-top:0.5rem;">Top Up Now</button>
                </form>
            </div>
        </div>
        <div class="card">
            <h3 class="mb-3">My Recent Courses</h3>
            <div id="recent-courses">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        requireRole('learner');
        updateUIBasedOnAuth();
        async function loadDashboardData() {
            try {
                const balanceData = await API.bank.getBalance();
                document.getElementById('balance').textContent = `${balanceData.data.balance.toFixed(2)} Tk`;
                document.getElementById('account-number').textContent = `Account: ${balanceData.data.account_number}`;
                const enrollmentsData = await API.learner.getMyEnrollments();
                document.getElementById('enrollment-count').textContent = enrollmentsData.data.length;
                const certificatesData = await API.learner.getCertificates();
                document.getElementById('certificate-count').textContent = certificatesData.data.length;
                const recentCoursesContainer = document.getElementById('recent-courses');
                if (enrollmentsData.data.length === 0) {
                    recentCoursesContainer.innerHTML = '<p style="color: var(--gray);">No courses enrolled yet. <a href="/learner/courses.html" style="color: var(--primary);">Browse courses</a></p>';
                } else {
                    recentCoursesContainer.innerHTML = enrollmentsData.data.slice(0, 3).map(enrollment => {
                        const isPending = enrollment.status === 'pending';
                        const statusClass = enrollment.status === 'completed' ? 'success' : isPending ? 'warning' : 'primary';
                        const statusLabel = isPending ? '‚è≥ Awaiting Instructor' : enrollment.status;
                        return `
            <div class="card mb-2">
              <div class="flex justify-between items-center">
                <div>
                  <h4>${enrollment.course.title}</h4>
                  <p style="color: var(--gray); margin: 0.5rem 0;">Instructor: ${enrollment.course.instructor.full_name}</p>
                  <span class="badge badge-${statusClass}">
                    ${statusLabel}
                  </span>
                </div>
                ${isPending
                                ? '<button class="btn btn-outline" disabled style="opacity: 0.5; cursor: not-allowed;">üîí Locked</button>'
                                : `<a href="/learner/course-view.html?id=${enrollment.course.id}" class="btn btn-primary">View Course</a>`
                            }
              </div>
            </div>
          `;
                    }).join('');
                }
            } catch (error) {
                handleAPIError(error);
                if (error.message.includes('Bank account')) {
                    setTimeout(() => {
                        window.location.href = '/learner/bank-setup.html';
                    }, 2000);
                }
            }
        }
        loadDashboardData();
        document.getElementById('topup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('topup-btn');
            const alertEl = document.getElementById('topup-alert');
            const amount = document.getElementById('topup-amount').value;
            const secret = document.getElementById('topup-secret').value;
            btn.disabled = true;
            btn.textContent = 'Processing...';
            alertEl.innerHTML = '';
            try {
                const res = await API.learner.topUp({ amount: parseFloat(amount), secret });
                alertEl.innerHTML = `<div class="alert alert-success">‚úÖ ${res.message} ¬∑ New Balance: <strong>${parseFloat(res.data.new_balance).toFixed(2)} Tk</strong></div>`;
                document.getElementById('balance').textContent = `${parseFloat(res.data.new_balance).toFixed(2)} Tk`;
                document.getElementById('topup-form').reset();
                setTimeout(() => {
                    document.getElementById('topup-modal').style.display = 'none';
                    alertEl.innerHTML = '';
                }, 2500);
            } catch (err) {
                alertEl.innerHTML = `<div class="alert alert-error">${err.message || 'Top up failed'}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Top Up Now';
            }
        });
    </script>
</body>
</html>